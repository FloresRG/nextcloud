---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Explorador">
	<div class="content-wrapper">
		<!-- Sidebar -->
		<aside class="sidebar">
			<div class="sidebar-section">
				<p class="section-title">Navegaci√≥n</p>
				<button class="sidebar-item active" id="btn-home" onclick="loadFolder('/')">
					<span class="icon">üè†</span> Inicio
				</button>
			</div>
			
			<div class="sidebar-section">
				<p class="section-title">Acciones</p>
				<button class="action-card" onclick="triggerFileSelect()">
					<div class="icon">üì§</div>
					<div>
						<p class="title">Subir Archivos</p>
						<p class="desc">Arrastra o selecciona</p>
					</div>
				</button>
				<button class="action-card" onclick="showCreateModal()">
					<div class="icon">üìÅ</div>
					<div>
						<p class="title">Nueva Carpeta</p>
						<p class="desc">Crear subdirectorio</p>
					</div>
				</button>
			</div>

			<div id="upload-queue-container" class="upload-sidebar-section" style="display:none">
				<div class="section-header">
					<p class="section-title">Subidas en curso</p>
					<span id="queue-count" class="badge">0</span>
				</div>
				<div id="upload-items-list" class="upload-list"></div>
			</div>
		</aside>

		<!-- Main Area -->
		<section class="main-area">
			<header class="view-header">
				<nav class="breadcrumb-nav" id="breadcrumb"></nav>
				<div class="view-controls">
					<div class="search-box">
						<span class="icon">üîç</span>
						<input type="text" id="fileSearch" placeholder="Buscar en esta carpeta..." />
					</div>
					<button class="icon-btn" onclick="loadFolder()" title="Refrescar">üîÑ</button>
				</div>
			</header>

			<div class="drop-zone" id="dropZone">
				<div class="drop-overlay">
					<div class="drop-info">
						<div class="icon">üì•</div>
						<p>Suelta los archivos para subirlos</p>
					</div>
				</div>
				<main class="file-view" id="fileGrid">
					<div class="loading-state">
						<div class="spinner"></div>
						<p>Sincronizando con Nexus...</p>
					</div>
				</main>
			</div>
		</section>
	</div>

	<!-- Modales -->
	<div class="modal-overlay" id="createModal">
		<div class="modal">
			<h3>üìÅ Nueva Carpeta</h3>
			<input type="text" id="folderName" placeholder="Nombre de la carpeta" autofocus />
			<div class="modal-actions">
				<button class="btn" onclick="closeModal('createModal')">Cancelar</button>
				<button class="btn btn-primary" onclick="createFolder()">Crear Carpeta</button>
			</div>
		</div>
	</div>

	<style>
		.content-wrapper {
			display: flex;
			flex: 1;
			height: calc(100vh - var(--header-height));
			overflow: hidden;
		}

		/* Sidebar Styles */
		.sidebar {
			width: var(--sidebar-width);
			background: var(--surface);
			border-right: 1px solid var(--border);
			padding: 1.5rem;
			display: flex;
			flex-direction: column;
			gap: 2rem;
			overflow-y: auto;
		}

		.sidebar-section { display: flex; flex-direction: column; gap: 0.5rem; }
		.section-title { 
			font-size: 0.75rem; 
			font-weight: 700; 
			text-transform: uppercase; 
			color: var(--text-muted);
			letter-spacing: 0.05em;
			margin: 0 0 0.5rem 0.5rem;
		}

		.sidebar-item {
			width: 100%;
			padding: 0.75rem 1rem;
			border: none;
			background: transparent;
			border-radius: var(--radius);
			color: var(--text-secondary);
			font-size: 0.9rem;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 0.75rem;
			cursor: pointer;
			text-align: left;
			transition: var(--transition);
		}

		.sidebar-item:hover, .sidebar-item.active {
			background: var(--bg);
			color: var(--text);
			box-shadow: var(--shadow-sm);
		}

		.action-card {
			width: 100%;
			padding: 1rem;
			border: 1px dashed var(--border);
			background: var(--bg);
			border-radius: var(--radius);
			display: flex;
			align-items: center;
			gap: 1rem;
			cursor: pointer;
			text-align: left;
			transition: var(--transition);
		}

		.action-card:hover {
			border-color: var(--primary);
			background: var(--surface);
			transform: scale(1.02);
		}

		.action-card .icon {
			font-size: 1.5rem;
			background: var(--surface-2);
			width: 44px;
			height: 44px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 10px;
			transition: var(--transition);
		}

		.action-card:hover .icon {
			background: var(--primary);
			color: white;
		}

		.action-card .title { font-weight: 600; font-size: 0.9rem; margin: 0; color: var(--text); }
		.action-card .desc { font-size: 0.75rem; color: var(--text-muted); margin: 0; }
		
		.action-card[onclick*="triggerFileSelect"] .icon { color: var(--primary); }
		.action-card[onclick*="showCreateModal"] .icon { color: var(--accent-2); }

		/* Main Area Styles */
		.main-area {
			flex: 1;
			display: flex;
			flex-direction: column;
			background: var(--bg);
			position: relative;
		}

		.view-header {
			padding: 1rem 2rem;
			border-bottom: 1px solid var(--border);
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 1rem;
			flex-wrap: wrap;
		}

		.breadcrumb-nav { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
		.breadcrumb-item { 
			color: var(--text-secondary); 
			cursor: pointer; 
			transition: var(--transition);
		}
		.breadcrumb-item:hover { color: var(--text); font-weight: 500; }
		.breadcrumb-separator { color: var(--text-muted); opacity: 0.5; }
		.breadcrumb-current { font-weight: 600; color: var(--text); }

		.view-controls { display: flex; align-items: center; gap: 0.75rem; }
		.search-box {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 50px;
			padding: 0.4rem 1rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			width: 260px;
		}

		.search-box input {
			border: none;
			background: transparent;
			outline: none;
			font-size: 0.85rem;
			width: 100%;
			color: var(--text);
		}

		.icon-btn {
			width: 36px;
			height: 36px;
			border-radius: 50%;
			border: 1px solid var(--border);
			background: var(--bg);
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: var(--transition);
		}
		.icon-btn:hover { background: var(--surface); border-color: var(--text); }

		/* Drop Zone & Grid */
		.drop-zone { flex: 1; position: relative; overflow-y: auto; }
		.drop-overlay {
			position: absolute;
			inset: 0.5rem;
			background: rgba(var(--bg-rgb), 0.9);
			border: 2px dashed var(--text);
			border-radius: var(--radius);
			z-index: 10;
			display: none;
			align-items: center;
			justify-content: center;
			pointer-events: none;
		}
		.drop-zone.dragging .drop-overlay { display: flex; }
		.drop-info { text-align: center; }
		.drop-info .icon { font-size: 3rem; margin-bottom: 1rem; }
		.drop-info p { font-weight: 600; font-size: 1.2rem; }

		.file-view {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
			gap: 1.5rem;
			padding: 2rem;
		}

		.file-card {
			padding: 1.25rem;
			background: var(--bg);
			border: 1px solid var(--border);
			border-radius: var(--radius);
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 0.75rem;
			cursor: pointer;
			transition: var(--transition);
			position: relative;
		}

		.file-card:hover {
			border-color: var(--primary);
			box-shadow: var(--shadow-md);
			transform: translateY(-4px);
			background: var(--surface);
		}

		.file-card .icon { 
			font-size: 2.8rem; 
			transition: var(--transition);
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.file-card:hover .icon {
			transform: scale(1.1);
		}

		.file-card .name {
			font-size: 0.85rem;
			font-weight: 600;
			text-align: center;
			width: 100%;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			color: var(--text);
		}
		.file-card .info { 
			font-size: 0.72rem; 
			color: var(--text-muted); 
			font-weight: 500;
		}

		/* Batch Upload SidebarSection */
		.upload-sidebar-section {
			background: var(--surface-2);
			border-radius: var(--radius);
			padding: 1rem;
			margin-top: auto;
		}
		.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
		.badge {
			background: var(--text);
			color: var(--bg);
			font-size: 0.7rem;
			font-weight: 700;
			padding: 0.1rem 0.4rem;
			border-radius: 4px;
		}
		.upload-list { display: flex; flex-direction: column; gap: 0.75rem; max-height: 200px; overflow-y: auto; }
		.upload-item { background: var(--bg); padding: 0.6rem; border-radius: 8px; font-size: 0.75rem; border: 1px solid var(--border); }
		.upload-item-name { 
			white-space: nowrap; 
			overflow: hidden; 
			text-overflow: ellipsis; 
			margin-bottom: 0.4rem; 
			font-weight: 500;
		}
		.progress-mini { height: 4px; background: var(--surface-2); border-radius: 2px; overflow: hidden; }
		.progress-fill-mini { height: 100%; background: var(--text); transition: width 0.3s ease; }

		.loading-state { grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-muted); }
		.spinner {
			width: 40px;
			height: 40px;
			border: 3px solid var(--border);
			border-top-color: var(--text);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin: 0 auto 1.5rem;
		}

		@keyframes spin { to { transform: rotate(360deg); } }

		@media (max-width: 768px) {
			.sidebar { display: none; }
			.view-header { padding: 1rem; }
			.file-view { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; padding: 1rem; }
		}
	</style>

	<script>
		// ============================================
		// UTILIDADES Y ESTADO GLOBAL
		// ============================================
		let currentPath = "/";
		let allFiles = []; // Cache para b√∫squeda
		const MAX_CONCURRENT_UPLOADS = 15; // Maximizado como solicit√≥ el usuario

		function showToast(msg, type = "success") {
			const t = document.getElementById("toast");
			if (!t) return;
			t.textContent = msg;
			t.className = `toast ${type} show`;
			setTimeout(() => t.classList.remove("show"), 3000);
		}

		function formatBytes(b) {
			if (b === 0) return "0 B";
			const k = 1024, sizes = ["B", "KB", "MB", "GB", "TB"];
			const i = Math.floor(Math.log(b) / Math.log(k));
			return parseFloat((b / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
		}

		function getFileIcon(name, isFolder, mime = "") {
			if (isFolder) return "<span>üìÅ</span>";
			const l = name.toLowerCase();
			if (mime.includes("video") || /\.(mp4|avi|mov|mkv)$/.test(l)) return "<span style='color:#ff9500'>üé¨</span>";
			if (mime.includes("image") || /\.(jpg|jpeg|png|gif|webp)$/.test(l)) return "<span style='color:#007aff'>üñºÔ∏è</span>";
			if (mime.includes("audio") || /\.(mp3|wav|ogg)$/.test(l)) return "<span style='color:#af52de'>üéµ</span>";
			if (mime.includes("pdf")) return "<span style='color:#ff3b30'>üìÑ</span>";
			if (/\.(zip|rar|7z|tar|gz)$/.test(l)) return "<span style='color:#5856d6'>üì¶</span>";
			if (/\.(doc|docx|txt|md)$/.test(l)) return "<span style='color:#5ac8fa'>üìù</span>";
			return "<span>üìÑ</span>";
		}

		function escapeHtml(t) {
			const d = document.createElement("div");
			d.textContent = t;
			return d.innerHTML;
		}

		// ============================================
		// GESTOR DE SUBIDAS (BATCH UPLOAD)
		// ============================================
		class UploadQueue {
			constructor() {
				this.queue = [];
				this.activeCount = 0;
				this.container = document.getElementById("upload-queue-container");
				this.list = document.getElementById("upload-items-list");
				this.countBadge = document.getElementById("queue-count");
			}

			add(file) {
				const id = 'up-' + Math.random().toString(36).substr(2, 9);
				const item = { id, file, status: 'pending', progress: 0 };
				this.queue.push(item);
				this.renderItem(item);
				this.updateUI();
				this.process();
			}

			renderItem(item) {
				const div = document.createElement('div');
				div.id = item.id;
				div.className = 'upload-item';
				div.innerHTML = `
					<div class="upload-item-name" title="${escapeHtml(item.file.name)}">
						<span style="color:var(--primary); margin-right:4px">‚¨ÜÔ∏è</span>
						<span>${escapeHtml(item.file.name)}</span>
					</div>
					<div class="progress-mini">
						<div class="progress-fill-mini" style="width: 0%; background: var(--primary)"></div>
					</div>
				`;
				this.list.prepend(div);
			}

			updateUI() {
				if (this.queue.length > 0) {
					this.container.style.display = 'block';
					this.countBadge.textContent = this.queue.length;
				} else {
					this.container.style.display = 'none';
				}
			}

			async process() {
				if (this.activeCount >= MAX_CONCURRENT_UPLOADS) return;
				
				const next = this.queue.find(i => i.status === 'pending');
				if (!next) return;

				next.status = 'uploading';
				this.activeCount++;
				
				await this.doUpload(next);
				
				this.activeCount--;
				this.process();
			}

			async doUpload(item) {
				const formData = new FormData();
				formData.append("file", item.file);
				formData.append("folderPath", currentPath);

				return new Promise((resolve) => {
					const xhr = new XMLHttpRequest();
					xhr.open("POST", "/api/upload", true);

					xhr.upload.onprogress = (e) => {
						if (e.lengthComputable) {
							const p = (e.loaded / e.total) * 100;
							const fill = document.querySelector(`#${item.id} .progress-fill-mini`);
							if (fill) fill.style.width = p + "%";
						}
					};

					xhr.onload = () => {
						const div = document.getElementById(item.id);
						if (xhr.status === 200) {
							div?.remove();
							this.queue = this.queue.filter(i => i.id !== item.id);
							showToast(`‚úÖ "${item.file.name}" subido`);
							if (this.queue.length === 0) loadFolder();
						} else {
							div.style.borderColor = 'var(--error)';
							showToast(`‚ùå Error al subir ${item.file.name}`, 'error');
						}
						this.updateUI();
						resolve();
					};

					xhr.onerror = () => {
						showToast("‚ùå Error de conexi√≥n", "error");
						resolve();
					};

					xhr.send(formData);
				});
			}
		}

		const uploader = new UploadQueue();

		// ============================================
		// NAVEGACI√ìN Y CARGA
		// ============================================
		async function loadFolder(path = currentPath) {
			currentPath = path;
			updateBreadcrumb();
			updateSidebarActive();

			const grid = document.getElementById("fileGrid");
			if (!grid) return;

			grid.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Sincronizando con Nexus...</p></div>';

			try {
				const encodedPath = encodeURIComponent(currentPath).replace(/%2F/g, "/");
				const apiUrl = `/api/files${encodedPath === "/" ? "" : encodedPath}`;
				console.log("[FRONTEND DEBUG] Loading Folder Path:", currentPath);
				console.log("[FRONTEND DEBUG] Fetching API URL:", apiUrl);
				
				const res = await fetch(apiUrl);
				console.log("[FRONTEND DEBUG] API Status:", res.status);
				
				const result = await res.json();
				console.log("[FRONTEND DEBUG] API Data:", result);

				if (!result.success) throw new Error(result.error || "Error desconocido");
				
				allFiles = result.items || [];
				console.log("[FRONTEND DEBUG] Rendered Files Count:", allFiles.length);
				renderFiles(allFiles);
			} catch (err) {
				grid.innerHTML = `<div class="loading-state"><div class="icon" style="font-size:3rem; margin-bottom:1rem">‚ùå</div><p>Error: ${err.message}</p><button class="btn" onclick="loadFolder()" style="margin-top:1rem">üîÑ Reintentar</button></div>`;
				showToast("Error al cargar: " + err.message, "error");
			}
		}

		function renderFiles(files) {
			const grid = document.getElementById("fileGrid");
			if (!grid) return;

			if (files.length === 0) {
				grid.innerHTML = `<div class="loading-state"><div class="icon" style="font-size:3rem; margin-bottom:1rem"><span>üìÇ</span></div><p>Esta carpeta est√° vac√≠a</p></div>`;
				return;
			}

			grid.innerHTML = files.map(f => `
				<div class="file-card" onclick="${f.isFolder ? `loadFolder('${f.path.replace(/'/g, "\\'")}')` : `openFile('${f.path.replace(/'/g, "\\'")}')`}">
					<div class="icon">${getFileIcon(f.name, f.isFolder, f.mime)}</div>
					<div class="name" title="${escapeHtml(f.name)}"><span>${escapeHtml(f.name)}</span></div>
					<div class="info"><span>${f.isFolder ? "Carpeta" : formatBytes(f.size)}</span></div>
				</div>
			`).join("");
		}

		function updateBreadcrumb() {
			const nav = document.getElementById("breadcrumb");
			if (!nav) return;

			const parts = currentPath.split("/").filter(p => p);
			let html = `<span class="breadcrumb-item" onclick="loadFolder('/')" style="color:var(--primary); display:flex; align-items:center; gap:4px"><span>üè†</span> <span>Inicio</span></span>`;
			let acc = "";

			parts.forEach((part, i) => {
				acc += "/" + part;
				html += '<span class="breadcrumb-separator">/</span>';
				if (i === parts.length - 1) {
					html += `<span class="breadcrumb-current">${escapeHtml(part)}</span>`;
				} else {
					html += `<span class="breadcrumb-item" onclick="loadFolder('${acc.replace(/'/g, "\\'")}')">${escapeHtml(part)}</span>`;
				}
			});

			nav.innerHTML = html;
		}

		function updateSidebarActive() {
			document.getElementById("btn-home")?.classList.toggle("active", currentPath === "/");
		}

		function openFile(path) {
			// Podr√≠amos usar una URL firmada o proxy, por ahora mantenemos el link directo al DAV
			const url = `http://192.168.1.50/remote.php/dav/files/admus${path}`;
			window.open(url, "_blank");
		}

		// ============================================
		// EVENTOS Y B√öSQUEDA
		// ============================================
		document.addEventListener("DOMContentLoaded", () => {
			loadFolder();

			// B√∫squeda en tiempo real
			document.getElementById("fileSearch")?.addEventListener("input", (e) => {
				const term = e.target.value.toLowerCase();
				const filtered = allFiles.filter(f => f.name.toLowerCase().includes(term));
				renderFiles(filtered);
			});

			// Hotkey para b√∫squeda
			window.addEventListener("keydown", (e) => {
				if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
					e.preventDefault();
					document.getElementById("fileSearch")?.focus();
				}
			});

			// Drag and Drop
			const dropZone = document.getElementById("dropZone");
			window.addEventListener("dragover", (e) => {
				e.preventDefault();
				dropZone?.classList.add("dragging");
			});
			window.addEventListener("dragleave", (e) => {
				if (e.relatedTarget === null) dropZone?.classList.remove("dragging");
			});
			dropZone?.addEventListener("drop", (e) => {
				e.preventDefault();
				dropZone?.classList.remove("dragging");
				const files = Array.from(e.dataTransfer.files);
				files.forEach(f => uploader.add(f));
			});
		});

		// Acciones de archivos
		window.triggerFileSelect = () => document.getElementById("fileInput")?.click();
		
		document.getElementById("fileInput")?.addEventListener("change", (e) => {
			const files = Array.from(e.target.files);
			files.forEach(f => uploader.add(f));
			e.target.value = "";
		});

		// Carpetas
		window.showCreateModal = () => {
			const m = document.getElementById("createModal");
			m.classList.add("active");
			document.getElementById("folderName").focus();
		};
		window.closeModal = (id) => document.getElementById(id).classList.remove("active");
		
		window.createFolder = async () => {
			const input = document.getElementById("folderName");
			const name = input.value.trim();
			if (!name) return;

			closeModal("createModal");
			try {
				const res = await fetch("/api/folder", {
					method: "POST",
					body: JSON.stringify({ folderName: name, parentPath: currentPath })
				});
				const resData = await res.json();
				if (resData.success) {
					showToast(`Carpeta "${name}" creada`);
					loadFolder();
				} else throw new Error(resData.error);
			} catch (err) {
				showToast("Error: " + err.message, "error");
			}
			input.value = "";
		};
	</script>
</Layout>

