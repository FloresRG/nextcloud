---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Explorador">
	<div class="content-wrapper">
		<!-- Main Area -->
		<section class="main-area">
			<!-- Toolbar (Windows style) -->
			<div class="toolbar">
				<div class="toolbar-group">
					<button class="tool-btn" onclick="triggerFileSelect()" title="Subir Archivos (Click o Arrastra)">
						<span class="icon">üìÅ</span>
						<span>Subir</span>
					</button>
					<button class="tool-btn" onclick="showCreateModal()" title="Nueva Carpeta">
						<span class="icon">‚ûï</span>
						<span>Nueva Carpeta</span>
					</button>
				</div>
				<div class="toolbar-divider"></div>
				<div class="toolbar-group">
					<button class="tool-btn icon-only" onclick="loadFolder()" title="Refrescar"><span>üîÑ</span></button>
					<button class="tool-btn icon-only" id="move-btn" disabled title="Mover selecci√≥n"><span>üì¶</span></button>
					<button class="tool-btn icon-only" id="delete-btn" disabled onclick="deleteSelection()" title="Eliminar selecci√≥n"><span>üóëÔ∏è</span></button>
				</div>
				<div style="flex:1"></div>
				<div class="search-box-v2">
					<span class="icon">üîç</span>
					<input type="text" id="fileSearch" placeholder="Buscar..." />
				</div>
			</div>

			<header class="view-header">
				<nav class="breadcrumb-nav" id="breadcrumb"></nav>
				<div class="view-stats" id="view-stats">
					<span id="file-count">0 items</span>
				</div>
			</header>

			<div class="drop-zone" id="dropZone">
				<div class="drop-overlay">
					<div class="drop-info">
						<div class="icon">üì•</div>
						<p>Suelta los archivos aqu√≠</p>
					</div>
				</div>
				<main class="file-view" id="fileGrid">
					<div class="loading-state">
						<div class="spinner"></div>
						<p>Iniciando Nexus...</p>
					</div>
				</main>
			</div>

			<!-- Dashboard de Subidas (Minimizable) -->
			<div id="upload-status-bar" class="upload-status-bar" style="display:none">
				<div class="status-header" onclick="toggleUploadList()">
					<span class="icon">‚òÅÔ∏è</span>
					<span id="status-text">Subiendo 0 archivos...</span>
					<span id="queue-count-v2" class="badge">0</span>
					<span class="toggle-icon">‚ñº</span>
				</div>
				<div id="upload-items-list-v2" class="upload-items-compact"></div>
			</div>
		</section>
	</div>

	<!-- Modales -->
	<div class="modal-overlay" id="createModal">
		<div class="modal">
			<h3>üìÅ Nueva Carpeta</h3>
			<input type="text" id="folderName" placeholder="Nombre de la carpeta" autofocus />
			<div class="modal-actions">
				<button class="btn" onclick="closeModal('createModal')">Cancelar</button>
				<button class="btn btn-primary" onclick="createFolder()">Crear Carpeta</button>
			</div>
		</div>
	</div>

		.content-wrapper {
			display: flex;
			flex: 1;
			height: calc(100vh - var(--header-height));
			overflow: hidden;
		}

		/* Toolbar (Windows style) */
		.toolbar {
			padding: 0.5rem 2rem;
			background: rgba(var(--bg-rgb), 0.7);
			border-bottom: 1px solid var(--border);
			display: flex;
			align-items: center;
			gap: 0.5rem;
			backdrop-filter: blur(8px);
			-webkit-backdrop-filter: blur(8px);
			z-index: 10;
		}

		.toolbar-group { display: flex; align-items: center; gap: 0.25rem; }
		.toolbar-divider { width: 1px; height: 1.5rem; background: var(--border); margin: 0 0.5rem; }

		.tool-btn {
			padding: 0.4rem 0.75rem;
			border: 1px solid transparent;
			background: transparent;
			border-radius: 6px;
			color: var(--text);
			font-size: 0.85rem;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			cursor: pointer;
			transition: var(--transition);
		}

		.tool-btn:hover:not(:disabled) {
			background: var(--surface-2);
			border-color: var(--border);
		}

		.tool-btn:disabled { opacity: 0.4; cursor: not-allowed; }
		.tool-btn.icon-only { padding: 0.4rem; justify-content: center; }
		.tool-btn .icon { font-size: 1.1rem; }

		.search-box-v2 {
			background: var(--bg);
			border: 1px solid var(--border);
			border-radius: 6px;
			padding: 0.3rem 0.75rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			width: 240px;
			transition: var(--transition);
		}
		.search-box-v2:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.1); }
		.search-box-v2 input { border: none; background: transparent; outline: none; font-size: 0.85rem; width: 100%; color: var(--text); }

		/* Main Sidebar is gone, context is now full */
		.main-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

		.view-header {
			padding: 1rem 2rem;
			display: flex;
			align-items: center;
			justify-content: space-between;
			background: var(--bg);
			border-bottom: 1px solid var(--border);
		}

		.breadcrumb-nav { display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem; color: var(--text-secondary); }
		.breadcrumb-item { cursor: pointer; padding: 0.2rem 0.4rem; border-radius: 4px; transition: var(--transition); }
		.breadcrumb-item:hover { background: var(--surface-2); color: var(--text); }
		.breadcrumb-current { font-weight: 600; color: var(--text); padding: 0.2rem 0.4rem; }

		.view-stats { font-size: 0.75rem; color: var(--text-muted); }

		/* File Grid & Selection */
		.drop-zone { flex: 1; position: relative; overflow-y: auto; }
		.file-view {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
			gap: 0.5rem;
			padding: 1rem 2rem;
		}

		.file-card {
			padding: 1rem;
			border: 1px solid transparent;
			border-radius: 8px;
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 0.5rem;
			cursor: pointer;
			transition: background 0.1s, border-color 0.1s;
			user-select: none;
		}

		.file-card:hover { background: rgba(var(--primary-rgb, 0, 122, 255), 0.05); border-color: rgba(var(--primary-rgb, 0, 122, 255), 0.1); }
		.file-card.selected { background: rgba(var(--primary-rgb, 0, 122, 255), 0.15); border-color: var(--primary); }

		.file-card .icon { font-size: 3rem; }
		.file-card .name {
			font-size: 0.8rem;
			text-align: center;
			width: 100%;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}
		.file-card .info { font-size: 0.7rem; color: var(--text-muted); }

		/* Upload Status Bar */
		.upload-status-bar {
			position: absolute;
			bottom: 0;
			left: 0;
			right: 0;
			background: var(--surface);
			border-top: 1px solid var(--border);
			z-index: 100;
			box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
		}

		.status-header {
			padding: 0.75rem 2rem;
			display: flex;
			align-items: center;
			gap: 1rem;
			cursor: pointer;
		}
		.status-header:hover { background: var(--surface-2); }
		#status-text { flex: 1; font-size: 0.85rem; font-weight: 500; }
		.toggle-icon { font-size: 0.6rem; transition: transform 0.3s; }
		.upload-status-bar.expanded .toggle-icon { transform: rotate(180deg); }

		.upload-items-compact {
			max-height: 0;
			overflow: hidden;
			transition: max-height 0.3s ease-out;
			background: var(--bg);
		}
		.upload-status-bar.expanded .upload-items-compact { max-height: 300px; overflow-y: auto; padding-bottom: 1rem; }

		.upload-item-compact {
			padding: 0.5rem 2rem;
			display: flex;
			align-items: center;
			gap: 1rem;
			border-bottom: 1px solid var(--border);
		}
		.upload-item-compact .name { flex: 1; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
		.progress-bar-v2 { width: 100px; height: 6px; background: var(--surface-2); border-radius: 3px; overflow: hidden; }
		.progress-fill-v2 { height: 100%; background: var(--primary); transition: width 0.3s; }

		.loading-state { grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-muted); }
		.spinner {
			width: 32px;
			height: 32px;
			border: 3px solid var(--border);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin: 0 auto 1.5rem;
		}

		@keyframes spin { to { transform: rotate(360deg); } }

		@media (max-width: 768px) {
			.toolbar { padding: 0.5rem 1rem; overflow-x: auto; }
			.view-header { padding: 0.75rem 1rem; }
			.file-view { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); padding: 1rem; }
			.search-box-v2 { display: none; }
		}
	</style>

	<script>
		// ============================================
		// UTILIDADES Y ESTADO GLOBAL
		// ============================================
		let currentPath = "/";
		let allFiles = []; // Cache para b√∫squeda
		const MAX_CONCURRENT_UPLOADS = 15; // Maximizado como solicit√≥ el usuario

		function showToast(msg, type = "success") {
			const t = document.getElementById("toast");
			if (!t) return;
			t.textContent = msg;
			t.className = `toast ${type} show`;
			setTimeout(() => t.classList.remove("show"), 3000);
		}

		function formatBytes(b) {
			if (b === 0) return "0 B";
			const k = 1024, sizes = ["B", "KB", "MB", "GB", "TB"];
			const i = Math.floor(Math.log(b) / Math.log(k));
			return parseFloat((b / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
		}

		function getFileIcon(name, isFolder, mime = "") {
			if (isFolder) return "<span>üìÅ</span>";
			const l = name.toLowerCase();
			if (mime.includes("video") || /\.(mp4|avi|mov|mkv)$/.test(l)) return "<span style='color:#ff9500'>üé¨</span>";
			if (mime.includes("image") || /\.(jpg|jpeg|png|gif|webp)$/.test(l)) return "<span style='color:#007aff'>üñºÔ∏è</span>";
			if (mime.includes("audio") || /\.(mp3|wav|ogg)$/.test(l)) return "<span style='color:#af52de'>üéµ</span>";
			if (mime.includes("pdf")) return "<span style='color:#ff3b30'>üìÑ</span>";
			if (/\.(zip|rar|7z|tar|gz)$/.test(l)) return "<span style='color:#5856d6'>üì¶</span>";
			if (/\.(doc|docx|txt|md)$/.test(l)) return "<span style='color:#5ac8fa'>üìù</span>";
			return "<span>üìÑ</span>";
		}

		function escapeHtml(t) {
			const d = document.createElement("div");
			d.textContent = t;
			return d.innerHTML;
		}

		const MAX_CONCURRENT_UPLOADS = 15;
		let selectedPath = null;
		let clickTimer = null;

		class UploadQueue {
			constructor() {
				this.queue = [];
				this.activeCount = 0;
				this.statusBar = document.getElementById("upload-status-bar");
				this.list = document.getElementById("upload-items-list-v2");
				this.countBadge = document.getElementById("queue-count-v2");
				this.statusLabel = document.getElementById("status-text");
			}

			add(file) {
				const id = 'up-' + Math.random().toString(36).substr(2, 9);
				const item = { id, file, status: 'pending', progress: 0 };
				this.queue.push(item);
				this.renderItem(item);
				this.updateUI();
				this.process();
			}

			renderItem(item) {
				const div = document.createElement('div');
				div.id = item.id;
				div.className = 'upload-item-compact';
				div.innerHTML = `
					<span class="icon" style="color:var(--text-muted)">üìÑ</span>
					<div class="name" title="${escapeHtml(item.file.name)}">${escapeHtml(item.file.name)}</div>
					<div class="progress-bar-v2">
						<div id="fill-${item.id}" class="progress-fill-v2" style="width: 0%"></div>
					</div>
				`;
				this.list.prepend(div);
			}

			updateUI() {
				const count = this.queue.length;
				if (count > 0) {
					this.statusBar.style.display = 'block';
					this.countBadge.textContent = count;
					this.statusLabel.textContent = `Gestionando ${count} archivo${count > 1 ? 's' : ''}...`;
				} else {
					this.statusBar.style.display = 'none';
				}
			}

			async process() {
				if (this.activeCount >= MAX_CONCURRENT_UPLOADS) return;
				const next = this.queue.find(i => i.status === 'pending');
				if (!next) return;

				next.status = 'uploading';
				this.activeCount++;
				await this.doUpload(next);
				this.activeCount--;
				this.process();
			}

			async doUpload(item) {
				const formData = new FormData();
				formData.append("file", item.file);
				formData.append("folderPath", currentPath);

				return new Promise((resolve) => {
					const xhr = new XMLHttpRequest();
					xhr.open("POST", "/api/upload", true);

					xhr.upload.onprogress = (e) => {
						if (e.lengthComputable) {
							const p = (e.loaded / e.total) * 100;
							const fill = document.getElementById(`fill-${item.id}`);
							if (fill) fill.style.width = p + "%";
						}
					};

					xhr.onload = () => {
						const div = document.getElementById(item.id);
						if (xhr.status === 200) {
							div?.remove();
							this.queue = this.queue.filter(i => i.id !== item.id);
							showToast(`‚úÖ "${item.file.name}" subido`);
							if (this.queue.length === 0) loadFolder();
						} else {
							showToast(`‚ùå Error al subir ${item.file.name}`, 'error');
						}
						this.updateUI();
						resolve();
					};

					xhr.onerror = () => {
						showToast("‚ùå Error de conexi√≥n", "error");
						resolve();
					};
					xhr.send(formData);
				});
			}
		}

		const uploader = new UploadQueue();

		// ============================================
		// NAVEGACI√ìN Y CARGA
		// ============================================
		async function loadFolder(path = currentPath) {
			currentPath = path;
			selectedPath = null;
			updateToolbarStates();
			updateBreadcrumb();

			const grid = document.getElementById("fileGrid");
			if (!grid) return;

			grid.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Iniciando Nexus...</p></div>';

			try {
				const encodedPath = encodeURIComponent(currentPath).replace(/%2F/g, "/");
				const res = await fetch(`/api/files${encodedPath === "/" ? "" : encodedPath}`);
				const result = await res.json();

				if (!result.success) throw new Error(result.error || "Error desconocido");
				
				allFiles = result.items || [];
				document.getElementById("file-count").textContent = `${allFiles.length} item${allFiles.length !== 1 ? 's' : ''}`;
				renderFiles(allFiles);
			} catch (err) {
				grid.innerHTML = `<div class="loading-state"><div class="icon" style="font-size:2rem">‚ùå</div><p>${err.message}</p></div>`;
			}
		}

		function renderFiles(files) {
			const grid = document.getElementById("fileGrid");
			if (!grid) return;

			if (files.length === 0) {
				grid.innerHTML = `<div class="loading-state"><span>üìÇ</span><p>Vac√≠o</p></div>`;
				return;
			}

			grid.innerHTML = files.map(f => `
				<div class="file-card" 
					 data-path="${f.path}" 
					 data-folder="${f.isFolder}"
					 onclick="handleFileClick(event, '${f.path.replace(/'/g, "\\'")}', ${f.isFolder})"
					 ondblclick="handleFileDblClick('${f.path.replace(/'/g, "\\'")}', ${f.isFolder})">
					<div class="icon">${getFileIcon(f.name, f.isFolder, f.mime)}</div>
					<div class="name" title="${escapeHtml(f.name)}">${escapeHtml(f.name)}</div>
					<div class="info">${f.isFolder ? "Carpeta" : formatBytes(f.size)}</div>
				</div>
			`).join("");
		}

		function handleFileClick(e, path, isFolder) {
			// Prevenir navegaci√≥n inmediata en un solo click
			e.stopPropagation();
			
			// Seleccionar visualmente
			document.querySelectorAll('.file-card').forEach(c => c.classList.remove('selected'));
			const card = e.currentTarget;
			card.classList.add('selected');
			
			selectedPath = path;
			updateToolbarStates();
		}

		function handleFileDblClick(path, isFolder) {
			if (isFolder) {
				loadFolder(path);
			} else {
				openFile(path);
			}
		}

		function updateToolbarStates() {
			const hasSelection = selectedPath !== null;
			document.getElementById("delete-btn").disabled = !hasSelection;
			document.getElementById("move-btn").disabled = !hasSelection;
		}

		async function deleteSelection() {
			if (!selectedPath) return;
			if (!confirm(`¬øEst√°s seguro de que quieres eliminar este elemento?`)) return;

			try {
				const res = await fetch("/api/delete", {
					method: "POST",
					body: JSON.stringify({ path: selectedPath })
				});
				const data = await res.json();
				if (data.success) {
					showToast("Elemento eliminado");
					loadFolder();
				} else throw new Error(data.error);
			} catch (err) {
				showToast("Error al eliminar: " + err.message, "error");
			}
		}

		function updateBreadcrumb() {
			const nav = document.getElementById("breadcrumb");
			if (!nav) return;

			const parts = currentPath.split("/").filter(p => p);
			let html = `<span class="breadcrumb-item" onclick="loadFolder('/')" style="color:var(--primary); display:flex; align-items:center; gap:4px"><span>üè†</span> <span>Inicio</span></span>`;
			let acc = "";

			parts.forEach((part, i) => {
				acc += "/" + part;
				html += '<span class="breadcrumb-separator">/</span>';
				if (i === parts.length - 1) {
					html += `<span class="breadcrumb-current">${escapeHtml(part)}</span>`;
				} else {
					html += `<span class="breadcrumb-item" onclick="loadFolder('${acc.replace(/'/g, "\\'")}')">${escapeHtml(part)}</span>`;
				}
			});

			nav.innerHTML = html;
		}

		function updateSidebarActive() {
			document.getElementById("btn-home")?.classList.toggle("active", currentPath === "/");
		}

		function openFile(path) {
			// Podr√≠amos usar una URL firmada o proxy, por ahora mantenemos el link directo al DAV
			const url = `http://192.168.1.50/remote.php/dav/files/admus${path}`;
			window.open(url, "_blank");
		}

		function toggleUploadList() {
			const bar = document.getElementById("upload-status-bar");
			bar.classList.toggle("expanded");
		}

		// ============================================
		// EVENTOS Y B√öSQUEDA
		// ============================================
		document.addEventListener("DOMContentLoaded", () => {
			loadFolder();

			// Deseleccionar al hacer click fuera
			document.addEventListener('click', (e) => {
				if (!e.target.closest('.file-card') && !e.target.closest('.toolbar')) {
					selectedPath = null;
					document.querySelectorAll('.file-card').forEach(c => c.classList.remove('selected'));
					updateToolbarStates();
				}
			});

			// B√∫squeda en tiempo real
			document.getElementById("fileSearch")?.addEventListener("input", (e) => {
				const term = e.target.value.toLowerCase();
				const filtered = allFiles.filter(f => f.name.toLowerCase().includes(term));
				renderFiles(filtered);
			});

			// Hotkey para b√∫squeda
			window.addEventListener("keydown", (e) => {
				if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
					e.preventDefault();
					document.getElementById("fileSearch")?.focus();
				}
			});

			// Drag and Drop
			const dropZone = document.getElementById("dropZone");
			window.addEventListener("dragover", (e) => {
				e.preventDefault();
				dropZone?.classList.add("dragging");
			});
			window.addEventListener("dragleave", (e) => {
				if (e.relatedTarget === null) dropZone?.classList.remove("dragging");
			});
			dropZone?.addEventListener("drop", (e) => {
				e.preventDefault();
				dropZone?.classList.remove("dragging");
				const files = Array.from(e.dataTransfer.files);
				files.forEach(f => uploader.add(f));
			});
		});

		window.toggleUploadList = toggleUploadList;

		// Acciones de archivos
		window.triggerFileSelect = () => document.getElementById("fileInput")?.click();
		
		document.getElementById("fileInput")?.addEventListener("change", (e) => {
			const files = Array.from(e.target.files);
			files.forEach(f => uploader.add(f));
			e.target.value = "";
		});

		// Carpetas
		window.showCreateModal = () => {
			const m = document.getElementById("createModal");
			m.classList.add("active");
			document.getElementById("folderName").focus();
		};
		window.closeModal = (id) => document.getElementById(id).classList.remove("active");
		
		window.createFolder = async () => {
			const input = document.getElementById("folderName");
			const name = input.value.trim();
			if (!name) return;

			closeModal("createModal");
			try {
				const res = await fetch("/api/folder", {
					method: "POST",
					body: JSON.stringify({ folderName: name, parentPath: currentPath })
				});
				const resData = await res.json();
				if (resData.success) {
					showToast(`Carpeta "${name}" creada`);
					loadFolder();
				} else throw new Error(resData.error);
			} catch (err) {
				showToast("Error: " + err.message, "error");
			}
			input.value = "";
		};
	</script>
</Layout>

